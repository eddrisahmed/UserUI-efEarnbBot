<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>efEarn App</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Ad Code -->
    <script src='//libtl.com/sdk.js' data-zone='9549781' data-sdk='show_9549781'></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #ffffff; }
        .dark-bg { background-color: #121212; }
        .card-bg { background-color: #1e1e1e; }
        .border-accent { border-color: #ff8c00; }
        .text-accent { color: #ff8c00; }
        /* ... ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
    </style>
</head>
<body class="max-w-md mx-auto">

    <!-- App Loader -->
    <div id="loader" class="fixed inset-0 dark-bg bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-accent"></div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen flex-col hidden">
        <!-- ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá -->
        <header class="flex items-center justify-between p-4 sticky top-0 bg-opacity-80 backdrop-blur-md z-10 dark-bg">
            <h1 class="text-xl font-bold">efEarn</h1>
            <div class="flex items-center space-x-4">
                <div class="streak-counter" id="streak-counter" style="display: none;">
                    <i data-lucide="flame" class="w-4 h-4"></i>
                    <span id="streak-days">0</span> ‡¶¶‡¶ø‡¶®
                </div>
                <div id="notification-bell" class="relative cursor-pointer">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <div id="notification-dot" class="notification-dot"></div>
                </div>
                <i data-lucide="user" class="w-6 h-6 cursor-pointer" onclick="navigateTo('profile-page')"></i>
            </div>
        </header>

        <main class="flex-grow">
            <!-- Home Page -->
            <div id="home-page" class="p-4 space-y-6 sub-page active">
                <!-- ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü -->
            </div>

            <!-- ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡ßá‡¶ú ‡¶ó‡ßÅ‡¶≤‡ßã -->
        </main>

        <nav class="bottom-nav sticky bottom-0 grid grid-cols-4 items-center text-center py-2 card-bg">
            <!-- ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® -->
        </nav>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ==================== FIREBASE ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ====================
            const firebaseConfig = {
  apiKey: "AIzaSyAVsY970aU6sa6Cu2Yw0WnbS3OfCW7QfaY",
  authDomain: "ef-earn-bot.firebaseapp.com",
  databaseURL: "https://ef-earn-bot-default-rtdb.firebaseio.com",
  projectId: "ef-earn-bot",
  storageBucket: "ef-earn-bot.firebasestorage.app",
  messagingSenderId: "700440287970",
  appId: "1:700440287970:web:e602a158b0cc670d3f1cbb"
};
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            
            lucide.createIcons();

            // ==================== IMPROVED TELEGRAM HANDLING ====================
            const tg = window.Telegram?.WebApp;
            let currentUser = null;
            let userData = null;

            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('app-container');

            // ==================== SMART TELEGRAM DETECTION ====================
            async function initializeApp() {
                loader.classList.remove('hidden');
                
                try {
                    // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Telegram environment check
                    const isTelegram = await checkTelegramEnvironment();
                    
                    if (isTelegram) {
                        console.log("Telegram environment detected");
                        await initializeTelegramUser();
                    } else {
                        console.log("Non-Telegram environment, using demo mode");
                        await initializeDemoUser();
                    }

                    // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£
                    await loadAppData();
                    showApp();
                    
                } catch (error) {
                    console.error('App initialization error:', error);
                    // Error ‡¶π‡¶≤‡ßá‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ demo mode ‡¶è
                    await initializeDemoUser();
                    showApp();
                } finally {
                    loader.classList.add('hidden');
                }
            }

            // ==================== TELEGRAM ENVIRONMENT CHECK ====================
            async function checkTelegramEnvironment() {
                // Multiple level check
                if (!window.Telegram?.WebApp) {
                    console.log("Telegram WebApp SDK not loaded");
                    return false;
                }

                const tg = window.Telegram.WebApp;
                
                // Check if we have user data
                const hasUserData = tg.initDataUnsafe?.user || tg.initData;
                if (!hasUserData) {
                    console.log("No Telegram user data available");
                    return false;
                }

                // Additional checks
                const isWebView = navigator.userAgent.includes('Telegram');
                const hasWebAppVersion = tg.version;

                console.log("Telegram check results:", {
                    hasSDK: true,
                    hasUserData: !!hasUserData,
                    isWebView: isWebView,
                    version: hasWebAppVersion,
                    platform: tg.platform
                });

                return true;
            }

            // ==================== TELEGRAM USER INITIALIZATION ====================
            async function initializeTelegramUser() {
                const tg = window.Telegram.WebApp;
                const tgUser = tg.initDataUnsafe?.user;
                
                if (!tgUser) {
                    throw new Error('No Telegram user data');
                }

                // Expand WebApp
                tg.expand();
                tg.enableClosingConfirmation();

                currentUser = {
                    uid: tgUser.id.toString(),
                    telegramData: tgUser,
                    isTelegramUser: true
                };

                await fetchOrCreateUser();
                console.log("Telegram user initialized:", currentUser);
            }

            // ==================== DEMO USER FOR NON-TELEGRAM ====================
            async function initializeDemoUser() {
                currentUser = {
                    uid: 'demo_user_' + Date.now(),
                    telegramData: {
                        id: 123456789,
                        first_name: 'Demo',
                        username: 'demo_user',
                        photo_url: ''
                    },
                    isTelegramUser: false,
                    isDemo: true
                };

                userData = {
                    uid: currentUser.uid,
                    balance: 100,
                    referralCode: 'DEMO123',
                    level: 1,
                    streakCount: 0,
                    totalTasksCompleted: 0,
                    totalEarned: 100,
                    totalWithdrawn: 0,
                    totalReferrals: 0
                };

                console.log("Demo user initialized");
            }

            // ==================== USER DATA MANAGEMENT ====================
            async function fetchOrCreateUser() {
                if (!currentUser.isTelegramUser) return;

                try {
                    const userDoc = await db.collection("users").doc(currentUser.uid).get();
                    
                    if (userDoc.exists) {
                        userData = userDoc.data();
                    } else {
                        await createNewUser();
                    }
                } catch (error) {
                    console.error("Error fetching user:", error);
                    await createNewUser();
                }
            }

            async function createNewUser() {
                const tgUser = currentUser.telegramData;
                const startParam = window.Telegram?.WebApp?.startParam;

                const newUserData = {
                    uid: currentUser.uid,
                    telegramData: tgUser,
                    balance: 50,
                    referralCode: generateReferralCode(),
                    referredBy: startParam || null,
                    referralBonusClaimed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    dailyAdCount: 0,
                    lastAdWatchDate: new Date().toISOString().split('T')[0],
                    level: 1,
                    experience: 0,
                    streakCount: 0,
                    lastTaskDate: null,
                    totalTasksCompleted: 0,
                    totalEarned: 50,
                    totalWithdrawn: 0,
                    totalReferrals: 0,
                    profileImage: tgUser.photo_url || "https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg"
                };

                await db.collection("users").doc(currentUser.uid).set(newUserData);
                userData = newUserData;
            }

            // ==================== APP DISPLAY ====================
            function showApp() {
                appContainer.classList.remove('hidden');
                updateUI();
                navigateTo('home-page');
                
                // Show welcome message based on user type
                if (currentUser.isTelegramUser) {
                    showAlert("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! efEarn ‡¶è ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! üéâ");
                } else {
                    showAlert("‡¶°‡ßá‡¶Æ‡ßã ‡¶Æ‡ßã‡¶°: ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá Telegram ‡¶¨‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®");
                }
            }

            // ==================== UI UPDATE ====================
            function updateUI() {
                if (!userData) return;
                
                // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.getElementById('coin-balance').textContent = userData.balance || 0;
                document.getElementById('wallet-coin-balance').textContent = userData.balance || 0;
                
                // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.getElementById('profile-name').textContent = 
                    userData.telegramData?.first_name || 'Demo User';
                
                if (userData.telegramData?.username) {
                    document.getElementById('profile-username').textContent = 
                        '@' + userData.telegramData.username;
                }
                
                // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°
                document.getElementById('referral-code').textContent = userData.referralCode || 'DEMO123';
            }

            // ==================== HELPER FUNCTIONS ====================
            function generateReferralCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            function navigateTo(pageId) {
                document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active', 'text-accent');
                    if (link.dataset.page === pageId) link.classList.add('active', 'text-accent');
                });
            }

            function showAlert(message) {
                // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ alert system ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                alert(message); // Temporary
            }

            // ==================== APP START ====================
            initializeApp();
        });
    </script>
</body>
</html>
